{{- if eq .chezmoi.os "darwin" -}}
#!/bin/bash
# This script installs npm global packages using available package manager

# Note: Not using 'set -e' to allow graceful error handling

# Determine which package manager to use (priority: bun > pnpm > npm)
PACKAGE_MANAGER=""
if command -v bun &> /dev/null; then
    PACKAGE_MANAGER="bun"
    echo "===== Installing npm Global Packages with Bun ====="
elif command -v pnpm &> /dev/null; then
    PACKAGE_MANAGER="pnpm"
    echo "===== Installing npm Global Packages with pnpm ====="
elif command -v npm &> /dev/null; then
    PACKAGE_MANAGER="npm"
    echo "===== Installing npm Global Packages with npm ====="
else
    echo "No supported package manager found (bun, pnpm, or npm). Please install one first."
    exit 1
fi

# Source NVM to ensure Node.js is available
export NVM_DIR="$HOME/.nvm"
[ -s "/opt/homebrew/opt/nvm/nvm.sh" ] && \. "/opt/homebrew/opt/nvm/nvm.sh"  # This loads nvm
[ -s "/opt/homebrew/opt/nvm/etc/bash_completion.d/nvm" ] && \. "/opt/homebrew/opt/nvm/etc/bash_completion.d/nvm"  # This loads nvm bash_completion

# Use LTS Node.js
if command -v nvm &> /dev/null; then
    nvm use --lts || echo "Warning: Failed to switch to LTS Node.js, continuing..."
fi

# Define arrays of packages to install
packages=(
    {{ range $package := .packages.npm.common.packages }}
    "{{ $package }}"
    {{ end }}

    {{ if .personal_computer }}
    {{ range $package := .packages.npm.personal_computer.packages }}
    "{{ $package }}"
    {{ end }}
    {{ end }}

    {{ if .work_computer }}
    {{ range $package := .packages.npm.work_computer.packages }}
    "{{ $package }}"
    {{ end }}
    {{ end }}
)

# Get list of currently installed global packages
echo "Checking currently installed global packages with $PACKAGE_MANAGER..."
case "$PACKAGE_MANAGER" in
    "bun")
        currently_installed=$(bun pm ls --global 2>/dev/null | grep -E '^[a-zA-Z@]' | awk '{print $1}' | sort || echo "")
        ;;
    "pnpm")
        currently_installed=$(pnpm list --global --depth=0 2>/dev/null | sed -n '/^dependencies:/,/^$/p' | grep -E '^[a-zA-Z@]' | grep -v '^dependencies:' | awk '{print $1}' | sort 2>/dev/null || echo "")
        ;;
    "npm")
        currently_installed=$(npm list --global --depth=0 2>/dev/null | grep -E '^[├└]─ ' | sed 's/[├└]─ //' | awk '{print $1}' | cut -d'@' -f1 | sort || echo "")
        ;;
esac

# Install packages
echo "Installing global packages..."
for package in "${packages[@]}"; do
    if [[ -z "$package" ]]; then
        continue  # Skip empty entries
    fi

    # Extract package name (handle scoped packages like @anthropic-ai/claude-code)
    package_name="$package"
    if [[ "$package" == *"@"* && "$package" != "@"* ]]; then
        # Handle packages with version specifiers
        package_name=$(echo "$package" | cut -d'@' -f1)
    fi

    # Check if package is already installed
    if echo "$currently_installed" | grep -q "^${package_name}"; then
        echo "Package already installed: $package_name"
    else
        echo "Installing package: $package"
        case "$PACKAGE_MANAGER" in
            "bun")
                bun install --global "$package" || echo "Failed to install $package, continuing..."
                ;;
            "pnpm")
                pnpm install --global "$package" || echo "Failed to install $package, continuing..."
                ;;
            "npm")
                npm install --global "$package" || echo "Failed to install $package, continuing..."
                ;;
        esac
    fi
done

echo "===== npm global packages installation complete! ====="
exit 0
{{- end }}